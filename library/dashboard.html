<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Katalogu - Biblioteka Lasgush Poradeci</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Nunito:wght@300;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    :root {
      --bg: #F5F1E3;
      --text: #3E2723;
      --card-bg: rgba(255, 255, 255, 0.95);
      --accent: #6D4C41;
      --accent-hover: #5D4037;
    }
    body.dark {
      --bg: #121212;
      --text: #E0E0E0;
      --card-bg: #1E1E1E;
      --accent: #8D6E63;
      --accent-hover: #A1887F;
    }
    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: 'Nunito', sans-serif;
      margin: 0;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; }

    header { text-align: center; margin-bottom: 40px; animation: fadeIn 1s ease-out; }
    h1 { font-family: 'Playfair Display', serif; font-size: 36px; margin-bottom: 10px; }

    .stats-bar {
      display: inline-flex; gap: 20px; background: rgba(0,0,0,0.05); padding: 8px 20px; border-radius: 20px; margin: 15px 0; font-size: 0.9rem;
    }
    body.dark .stats-bar { background: rgba(255,255,255,0.1); }

    .controls {
      display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 30px;
      background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    input, select { padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; }
    input { flex: 1; min-width: 200px; }

    /* Modern Book Card Design */
    .book-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 30px; }

    .book {
      background: transparent; perspective: 1000px; cursor: pointer;
    }
    .book-inner {
      background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s; overflow: hidden; height: 100%; display: flex; flex-direction: column;
    }
    .book:hover .book-inner { transform: translateY(-8px); box-shadow: 0 12px 25px rgba(0,0,0,0.15); }

    /* CSS Generated Cover */
    .book-cover {
      height: 160px; display: flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, var(--accent) 0%, #3e2723 100%);
      color: rgba(255,255,255,0.9); font-family: 'Playfair Display', serif;
      font-size: 3rem; position: relative;
    }
    .book-cover::after {
      content: ''; position: absolute; left: 10px; top: 0; bottom: 0; width: 2px;
      background: rgba(0,0,0,0.2); box-shadow: 1px 0 1px rgba(255,255,255,0.1);
    }

    .book-details { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
    .book h3 { font-family: 'Playfair Display', serif; font-size: 18px; margin: 0 0 5px 0; color: var(--text); line-height: 1.3; }
    .book-meta { font-size: 13px; color: var(--text); opacity: 0.8; margin-bottom: 10px; }

    .status-badge {
      font-size: 11px; padding: 4px 8px; border-radius: 4px; font-weight: bold; align-self: flex-start; margin-top: auto;
    }
    .available { background-color: #e8f5e9; color: #2e7d32; }
    .unavailable { background-color: #ffebee; color: #c62828; }

    /* Modal Styles */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(3px);
    }
    .modal-content {
      background: var(--card-bg); width: 90%; max-width: 600px; border-radius: 12px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3); overflow: hidden; display: flex; flex-direction: column;
      animation: zoomIn 0.3s ease; position: relative;
    }
    .modal-header {
      padding: 20px; background: var(--accent); color: white; display: flex; justify-content: space-between; align-items: center;
    }
    .modal-body { padding: 30px; color: var(--text); line-height: 1.6; }
    .modal-footer { padding: 20px; border-top: 1px solid rgba(0,0,0,0.1); text-align: right; }
    .close-modal { cursor: pointer; font-size: 1.5rem; color: white; }
    .login-btn-modal {
      background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 6px;
      font-size: 1rem; cursor: pointer; text-decoration: none; display: inline-block;
    }
    .login-btn-modal:hover { background: var(--accent-hover); }

    #darkToggle { position: fixed; top: 20px; right: 20px; background: var(--card-bg); border: 1px solid var(--text); color: var(--text); padding: 8px 12px; border-radius: 20px; cursor: pointer; z-index: 100; font-size: 20px; }
    #scrollTopBtn { position: fixed; bottom: 30px; right: 30px; padding: 12px 16px; background: var(--accent); color: white; border: none; border-radius: 50%; cursor: pointer; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

    .pagination { margin: 30px 0; display: flex; justify-content: center; gap: 10px; }
    .page-btn { padding: 8px 16px; border: 1px solid var(--accent); background: var(--card-bg); color: var(--text); cursor: pointer; border-radius: 4px; }
    .page-btn.active { background: var(--accent); color: white; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  

    /* Mobile & small screens: make layout more flexible */
    @media (max-width: 900px) {
      .controls { gap: 12px; }
      .book-list { gap: 20px; }
    }

    @media (max-width: 700px) {
      body { padding: 14px; }
      h1 { font-size: 28px; }
      .controls { flex-direction: column; align-items: stretch; }
      .controls input, .controls select { width: 100%; min-width: 0; box-sizing: border-box; }
      .stats-bar { gap: 12px; flex-wrap: wrap; justify-content: center; }
      .book-cover { height: 140px; font-size: 2.5rem; }
      .modal-content { width: 95%; max-height: 92vh; }
      .modal-body { padding: 18px; overflow: auto; }
      .modal-header { padding: 14px 16px; }
      .modal-footer { padding: 14px 16px; }
    }

    @media (max-width: 420px) {
      .book-list { grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); }
      .book-cover { height: 130px; }
    }



    /* Mobile-first tweaks */
    @media (max-width: 900px) {
      body { padding: 14px; }
      .controls { padding: 14px; }
    }

    @media (max-width: 700px) {
      .controls { flex-direction: column; align-items: stretch; }
      input, select { width: 100%; box-sizing: border-box; }
      #darkToggle { top: 12px; right: 12px; }
      #scrollTopBtn { bottom: 18px; right: 18px; }
      .book-list { gap: 18px; }
      .book-cover { height: 140px; }
      h1 { font-size: 30px; }
    }

    @media (max-width: 480px) {
      h1 { font-size: 26px; }
      .modal-content { width: 94%; max-height: 92vh; }
      .modal-body { padding: 18px; overflow: auto; }
      .modal-footer { padding: 14px; }
      .modal-header { padding: 14px; }
      .stats-bar { gap: 10px; padding: 8px 12px; flex-wrap: wrap; justify-content: center; }
    }

</style>
  <script type="importmap">
  {
    "imports": {
      "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
      "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js"
    }
  }
  </script>
</head>
<body>
  <button id="darkToggle" onclick="toggleDarkMode()" title="Ndrysho Sfondin"><i class="fas fa-moon"></i></button>

  <!-- Details Modal -->
  <div id="bookModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title" style="margin:0; font-family:'Playfair Display', serif;">Titulli</h2>
        <span class="close-modal" onclick="document.getElementById('bookModal').style.display='none'">&times;</span>
      </div>
      <div class="modal-body">
        <p><strong><i class="fas fa-pen-nib"></i> Autori:</strong> <span id="modal-author"></span></p>
        <p><strong><i class="fas fa-layer-group"></i> Zhanri:</strong> <span id="modal-genre"></span></p>
        <p><strong><i class="fas fa-star" style="color:#FFD700"></i> Vlerësimi:</strong> <span id="modal-rating"></span></p>
        <p><strong><i class="fas fa-hashtag"></i> Gjendja:</strong> <span id="modal-qty"></span></p>
        <hr style="border:0; border-top:1px solid rgba(0,0,0,0.1); margin:15px 0;">
        <p id="modal-desc"></p>

        <!-- Libra Audio (inline playback, no redirects) -->
        <div id="modal-audio" style="margin-top:18px;"></div>

        <!-- Guest rating (1-5 stars) -->
        <div id="guest-rating" style="margin-top:18px;">
          <h3 style="margin:0 0 10px 0; font-family:'Playfair Display', serif; font-size:18px;">Vlerëso Librin</h3>
          <div style="display:grid; gap:10px;">
            <select id="rate-stars" style="padding:10px; border-radius:8px; border:1px solid #ccc;">
              <option value="5">★★★★★ (5)</option>
              <option value="4">★★★★☆ (4)</option>
              <option value="3">★★★☆☆ (3)</option>
              <option value="2">★★☆☆☆ (2)</option>
              <option value="1">★☆☆☆☆ (1)</option>
            </select>
            <input id="rate-name" type="text" placeholder="Emri (opsional)" style="padding:10px; border-radius:8px; border:1px solid #ccc;" />
            <textarea id="rate-comment" rows="3" placeholder="Koment (opsional)" style="padding:10px; border-radius:8px; border:1px solid #ccc; resize:vertical;"></textarea>
          </div>
          <div id="rate-msg" style="margin-top:10px; font-size:0.95rem;"></div>
          <button id="rate-submit" class="login-btn-modal" type="button" style="margin-top:10px;"><i class="fas fa-star"></i> Dërgo Vlerësimin</button>
        </div>

        <!-- Borrow request form (guest mode) -->
        <div id="guest-request" style="margin-top:18px;">
          <h3 style="margin:0 0 10px 0; font-family:'Playfair Display', serif; font-size:18px;">
            Kërkesë për Tërheqje
          </h3>
          <div style="display:grid; gap:10px;">
            <input id="br-name" type="text" placeholder="Emri dhe Mbiemri" style="padding:10px; border-radius:8px; border:1px solid #ccc;" />
            <input id="br-email" type="email" placeholder="Email" style="padding:10px; border-radius:8px; border:1px solid #ccc;" />
            <input id="br-class" type="text" placeholder="Klasa" style="padding:10px; border-radius:8px; border:1px solid #ccc;" />
          </div>
          <div id="br-msg" style="margin-top:10px; font-size:0.95rem;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <span style="font-size:0.9rem; margin-right:10px; opacity:0.8;">Dëshironi ta tërhiqni?</span>
        <button id="br-submit" class="login-btn-modal" type="button"><i class="fas fa-paper-plane"></i> Dërgo Kërkesën</button>
      </div>
    </div>
  </div>

  <div class="container">
    <header>
      <h1>Katalogu i Bibliotekës</h1>
      <div class="greeting-box"><span id="datetime"></span></div>
      <div class="stats-bar">
        <span><i class="fas fa-book"></i> <span id="total-books-count">0</span> Libra</span>
        <span><i class="fas fa-eye"></i> Modaliteti Vizitor</span>
      </div>
    </header>

    <div class="controls">
      <input type="text" id="search-input" placeholder="Kërko titullin, autorin..." oninput="resetPage()">
      <select id="sort-option" onchange="resetPage()">
        <option value="title-asc">Titulli (A-Z)</option>
        <option value="title-desc">Titulli (Z-A)</option>
        <option value="author-asc">Autori (A-Z)</option>
      </select>
      <select id="grade-filter" onchange="resetPage()">
        <option value="all">Të gjitha klasat</option>
        <option value="1">Klasa 1</option>
        <option value="2">Klasa 2</option>
        <option value="3">Klasa 3</option>
        <option value="4">Klasa 4</option>
        <option value="5">Klasa 5</option>
        <option value="6">Klasa 6</option>
        <option value="7">Klasa 7</option>
        <option value="8">Klasa 8</option>
        <option value="9">Klasa 9</option>
      </select>
    </div>

    <div id="loading" style="text-align:center; font-size:1.2em; color: var(--accent);"><i class="fas fa-spinner fa-spin"></i> Duke ngarkuar librat...</div>
    <div class="book-list" id="book-list"></div>
    <div class="pagination" id="pagination"></div>
    <div id="no-books" style="display: none; text-align: center; font-size: 1.2em; margin-top: 40px;">Nuk u gjet asnjë libër me këto kritere.</div>
  </div>

  <button id="scrollTopBtn" onclick="scrollToTop()"><i class="fas fa-arrow-up"></i></button>

  <script type="module">
    import { initializeApp } from "firebase/app";
    import { getDatabase, ref, get, push, set } from "firebase/database";

    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark');
      document.querySelector('#darkToggle i').classList.replace('fa-moon', 'fa-sun');
    }

    const firebaseConfig = {
      apiKey: "AIzaSyBO5IVsYnIo9-HB3x-aFYWo00nQHeTJl-A",
      authDomain: "library-system-18d69.firebaseapp.com",
      databaseURL: "https://library-system-18d69-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "library-system-18d69",
      storageBucket: "library-system-18d69.appspot.com",
      messagingSenderId: "888263371866",
      appId: "1:888263371866:web:67e59dc03131d3bcfa7c63"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let books = [];
    let currentPage = 1;
    const ITEMS_PER_PAGE = 12;
    let selectedBook = null;

    function calcAvgRating(ratings) {
      if (!ratings) return 0;
      const vals = Object.values(ratings);
      const nums = vals
        .map(v => (typeof v === 'number') ? v : Number(v && v.rating ? v.rating : 0))
        .filter(n => n > 0);
      if (nums.length === 0) return 0;
      return nums.reduce((a, b) => a + b, 0) / nums.length;
    }

    function updateDateTime() {
      const now = new Date();
      document.getElementById('datetime').textContent = new Intl.DateTimeFormat('sq-AL', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }).format(now);
    }

    async function fetchBooks() {
      const loader = document.getElementById('loading');
      try {
        const snapshot = await get(ref(db, 'books'));
        if (snapshot.exists()) {
          const data = snapshot.val();
          books = Object.entries(data).map(([key, val]) => ({ ...val, id: key }));
          document.getElementById('total-books-count').innerText = books.length;
          renderBooks();
        } else {
          document.getElementById('no-books').style.display = 'block';
        }
      } catch (err) {
        console.error(err);
      } finally {
        loader.style.display = 'none';
      }
    }

    window.resetPage = () => { currentPage = 1; renderBooks(); };

    function renderBooks() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const sort = document.getElementById('sort-option').value;
      const grade = document.getElementById('grade-filter').value;

      let filtered = books.filter(b => {
        const mS = (b.title?.toLowerCase().includes(searchTerm) || b.author?.toLowerCase().includes(searchTerm));
        const mG = grade === 'all' || b.recommended == grade;
        return mS && mG;
      });

      if (sort === 'title-asc') filtered.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
      if (sort === 'title-desc') filtered.sort((a, b) => (b.title || '').localeCompare(a.title || ''));
      if (sort === 'author-asc') filtered.sort((a, b) => (a.author || '').localeCompare(b.author || ''));

      const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      const pagedData = filtered.slice(start, start + ITEMS_PER_PAGE);

      const list = document.getElementById('book-list');
      list.innerHTML = '';

      if (filtered.length === 0) {
        document.getElementById('no-books').style.display = 'block';
        document.getElementById('pagination').innerHTML = '';
        return;
      }
      document.getElementById('no-books').style.display = 'none';

      pagedData.forEach(book => {
        const qty = parseInt(book.quantity) || 0;
        const avg = calcAvgRating(book.ratings);

        const div = document.createElement('div');
        div.className = 'book';
        const hue = ((book.title || '').length * 20) % 360;
        const coverStyle = `background: linear-gradient(135deg, hsl(${hue}, 40%, 40%) 0%, hsl(${hue}, 60%, 20%) 100%);`;

        div.innerHTML = `
          <div class="book-inner">
            <div class="book-cover" style="${coverStyle}">
              <i class="fas fa-book-open"></i>
            </div>
            <div class="book-details">
              <h3>${escapeHtml(book.title || "Pa Titull")}</h3>
              <div class="book-meta">${escapeHtml(book.author || 'Anonim')}</div>
              <div class="book-meta">${avg > 0 ? '★ ' + avg.toFixed(1) : 'Pa vlerësime'}</div>
              <span class="status-badge ${qty > 0 ? 'available' : 'unavailable'}">${qty > 0 ? 'I Disponueshëm' : 'I Zënë'}</span>
            </div>
          </div>
        `;
        div.onclick = () => openModal(book, avg);
        list.appendChild(div);
      });

      renderPagination(totalPages);
    }

    // Modal Logic
    window.openModal = (book, avgRating) => {
      selectedBook = book;
      document.getElementById('modal-title').textContent = book.title || 'Pa titull';
      document.getElementById('modal-author').textContent = book.author || 'Anonim';
      document.getElementById('modal-genre').textContent = book.genre || 'Tjetër';
      document.getElementById('modal-rating').textContent = avgRating > 0 ? avgRating.toFixed(1) + ' / 5' : 'Ende pa vlerësime';
      document.getElementById('modal-qty').textContent = (parseInt(book.quantity) || 0) > 0 ? `${book.quantity} kopje në dispozicion` : 'Stoku ka mbaruar';
      document.getElementById('modal-desc').textContent = book.description || 'Nuk ka përshkrim të detajuar për këtë libër.';

      // Libra Audio (inline player)
      const audioDiv = document.getElementById('modal-audio');
      audioDiv.innerHTML = '';
      if (book.audioUrl) {
        const safeUrl = String(book.audioUrl);
        audioDiv.innerHTML = `
          <h3 style="margin:0 0 10px 0; font-family:'Playfair Display', serif; font-size:18px;">Libra Audio</h3>
          <audio controls style="width:100%;">
            <source src="${safeUrl}" type="audio/mpeg">
            <source src="${safeUrl}" type="audio/ogg">
            Shfletuesi juaj nuk e mbështet audion.
          </audio>
        `;
      } else {
        audioDiv.innerHTML = '<p style="opacity:0.85; margin:0;">Nuk ka Libra Audio për këtë libër.</p>';
      }

      // Reset request form
      const brMsg = document.getElementById('br-msg');
      brMsg.textContent = '';
      brMsg.style.color = '';
      document.getElementById('br-name').value = '';
      document.getElementById('br-email').value = '';
      document.getElementById('br-class').value = '';

      // Reset rating form
      const rateMsg = document.getElementById('rate-msg');
      if (rateMsg) { rateMsg.textContent = ''; rateMsg.style.color = ''; }
      const rs = document.getElementById('rate-stars');
      if (rs) rs.value = '5';
      const rn = document.getElementById('rate-name');
      if (rn) rn.value = '';
      const rc = document.getElementById('rate-comment');
      if (rc) rc.value = '';

      document.getElementById('bookModal').style.display = 'flex';
    };

    // Send borrow request (guest)
    document.getElementById('br-submit').addEventListener('click', async () => {
      const msg = document.getElementById('br-msg');
      const name = document.getElementById('br-name').value.trim();
      const email = document.getElementById('br-email').value.trim();
      const klass = document.getElementById('br-class').value.trim();

      if (!selectedBook || !selectedBook.id) {
        msg.style.color = 'crimson';
        msg.textContent = 'Gabim: Libri nuk u gjet.';
        return;
      }
      if (!name || !email || !klass) {
        msg.style.color = 'crimson';
        msg.textContent = 'Ju lutem plotësoni Emrin, Email dhe Klasën.';
        return;
      }

      const btn = document.getElementById('br-submit');
      btn.disabled = true;
      btn.style.opacity = '0.7';
      msg.textContent = 'Duke dërguar...';
      msg.style.color = '';

      try {
        const now = new Date();
        const date = new Intl.DateTimeFormat('sq-AL', { day: '2-digit', month: '2-digit', year: 'numeric' }).format(now);

        // Format time as 12-hour with Albanian suffix
        // "m.d e paradites" for AM, "m.d e pasdites" for PM
        const hh24 = now.getHours();
        const mm = String(now.getMinutes()).padStart(2, '0');
        const hh12 = ((hh24 % 12) || 12);
        const suffix = (hh24 >= 12) ? 'e pasdites' : 'e paradites';
        const time = `${String(hh12).padStart(2,'0')}:${mm} ${suffix}`;

        const reqRef = push(ref(db, 'borrow_requests'));
        await set(reqRef, {
          borrowerName: name,
          borrowerEmail: email,
          borrowerClass: klass,
          bookId: selectedBook.id,
          bookTitle: selectedBook.title || '',
          status: 'Pending',
          date,
          time,
          timestamp: Date.now()
        });
        msg.style.color = 'green';
        msg.textContent = 'Kërkesa u dërgua me sukses!';
      } catch (err) {
        console.error(err);
        msg.style.color = 'crimson';
        msg.textContent = 'Gabim: nuk u arrit dërgimi i kërkesës.';
      } finally {
        btn.disabled = false;
        btn.style.opacity = '';
      }
    });

    // Send rating (guest)
    const rateBtn = document.getElementById('rate-submit');
    if (rateBtn) {
      rateBtn.addEventListener('click', async () => {
        const msg = document.getElementById('rate-msg');
        const stars = parseInt((document.getElementById('rate-stars') || {}).value || '0', 10);
        const name = (document.getElementById('rate-name') || {}).value ? document.getElementById('rate-name').value.trim() : '';
        const comment = (document.getElementById('rate-comment') || {}).value ? document.getElementById('rate-comment').value.trim() : '';

        if (!selectedBook || !selectedBook.id) {
          if (msg) { msg.style.color = 'crimson'; msg.textContent = 'Gabim: Libri nuk u gjet.'; }
          return;
        }
        if (!stars || stars < 1 || stars > 5) {
          if (msg) { msg.style.color = 'crimson'; msg.textContent = 'Ju lutem zgjidhni vlerësimin (1-5).'; }
          return;
        }

        rateBtn.disabled = true;
        rateBtn.style.opacity = '0.7';
        if (msg) { msg.style.color = ''; msg.textContent = 'Duke dërguar vlerësimin...'; }

        try {
          const rRef = push(ref(db, `books/${selectedBook.id}/ratings`));
          await set(rRef, {
            rating: stars,
            name: name || null,
            comment: comment || null,
            timestamp: Date.now()
          });

          // Update UI
          selectedBook.ratings = selectedBook.ratings || {};
          selectedBook.ratings[rRef.key] = { rating: stars };

          const avgNow = calcAvgRating(selectedBook.ratings);
          document.getElementById('modal-rating').textContent = avgNow > 0 ? avgNow.toFixed(1) + ' / 5' : 'Ende pa vlerësime';

          const idx = books.findIndex(b => b.id === selectedBook.id);
          if (idx >= 0) {
            books[idx].ratings = { ...(books[idx].ratings || {}), [rRef.key]: { rating: stars } };
            renderBooks();
          }

          if (msg) { msg.style.color = 'green'; msg.textContent = 'Faleminderit! Vlerësimi u ruajt.'; }
        } catch (err) {
          console.error(err);
          if (msg) { msg.style.color = 'crimson'; msg.textContent = 'Gabim: nuk u arrit ruajtja e vlerësimit.'; }
        } finally {
          rateBtn.disabled = false;
          rateBtn.style.opacity = '';
        }
      });
    }

    window.closeModal = (e) => {
      if (e.target.id === 'bookModal') {
        document.getElementById('bookModal').style.display = 'none';
      }
    };

    function renderPagination(total) {
      const container = document.getElementById('pagination');
      container.innerHTML = '';
      if (total <= 1) return;
      for (let i = 1; i <= total; i++) {
        const btn = document.createElement('button');
        btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
        btn.innerText = i;
        btn.onclick = () => { currentPage = i; renderBooks(); };
        container.appendChild(btn);
      }
    }

    function escapeHtml(text) {
      return text ? String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
    }

    window.toggleDarkMode = () => {
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
      document.querySelector('#darkToggle i').classList.replace(
        document.body.classList.contains('dark') ? 'fa-moon' : 'fa-sun',
        document.body.classList.contains('dark') ? 'fa-sun' : 'fa-moon'
      );
    };

    window.scrollToTop = () => { window.scrollTo({ top: 0, behavior: 'smooth' }); };
    window.onscroll = () => { document.getElementById('scrollTopBtn').style.display = window.scrollY > 300 ? 'block' : 'none'; };

    updateDateTime();
    fetchBooks();
  </script>
</body>
</html>
